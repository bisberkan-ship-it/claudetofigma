<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      background: #2c2c2c;
      color: #e0e0e0;
      font-size: 13px;
    }
    #status {
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 12px;
      font-weight: 600;
    }
    .connected { background: #1b4332; color: #95d5b2; }
    .disconnected { background: #5c1a1a; color: #f4a4a4; }
    .connecting { background: #4a3800; color: #ffd966; }
    #log {
      background: #1e1e1e;
      border-radius: 6px;
      padding: 8px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 11px;
      line-height: 1.5;
    }
    .log-entry { margin: 2px 0; }
    .log-in { color: #7ec8e3; }
    .log-out { color: #a8d08d; }
    .log-err { color: #f4a4a4; }
    button {
      margin-top: 8px;
      padding: 6px 14px;
      border: none;
      border-radius: 4px;
      background: #0d99ff;
      color: white;
      cursor: pointer;
      font-size: 12px;
    }
    button:hover { background: #0b85e0; }
  </style>
</head>
<body>
  <div id="status" class="disconnected">Disconnected</div>
  <div id="log"></div>
  <button onclick="toggleConnection()">Connect</button>

  <script>
    let ws = null;
    let isConnected = false;

    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const btn = document.querySelector('button');

    function log(msg, cls) {
      const div = document.createElement('div');
      div.className = 'log-entry ' + (cls || '');
      div.textContent = msg;
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setStatus(text, cls) {
      statusEl.textContent = text;
      statusEl.className = cls;
    }

    const WS_URLS = ['ws://127.0.0.1:9000', 'ws://localhost:9000'];
    let wsUrlIndex = 0;

    function connect() {
      if (ws) ws.close();
      setStatus('Connecting...', 'connecting');
      const url = WS_URLS[wsUrlIndex % WS_URLS.length];
      log('Connecting to ' + url + '...');

      ws = new WebSocket(url);

      ws.onopen = () => {
        isConnected = true;
        setStatus('Connected', 'connected');
        btn.textContent = 'Disconnect';
        log('Connected to MCP server');
      };

      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          log('← ' + JSON.stringify(msg).substring(0, 120), 'log-in');
          // Forward to plugin code.ts
          parent.postMessage({ pluginMessage: { type: 'ws_message', data: msg } }, '*');
        } catch (e) {
          log('Failed to parse: ' + e.message, 'log-err');
        }
      };

      ws.onclose = () => {
        isConnected = false;
        setStatus('Disconnected', 'disconnected');
        btn.textContent = 'Connect';
        log('Disconnected');
      };

      ws.onerror = (err) => {
        log('WebSocket error on ' + url, 'log-err');
        // Try next URL on error
        wsUrlIndex++;
        if (wsUrlIndex < WS_URLS.length) {
          log('Trying fallback...', 'log-err');
          setTimeout(connect, 500);
        }
      };
    }

    function disconnect() {
      if (ws) ws.close();
    }

    function toggleConnection() {
      if (isConnected) disconnect();
      else connect();
    }

    // Receive results from code.ts and send back via WebSocket
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      if (msg.type === 'ws_response') {
        if (ws && ws.readyState === WebSocket.OPEN) {
          const payload = JSON.stringify(msg.data);
          log('→ ' + payload.substring(0, 120), 'log-out');
          ws.send(payload);
        } else {
          log('Cannot send: WebSocket not connected', 'log-err');
        }
      }
    };

    // Auto-connect on load
    setTimeout(connect, 500);
  </script>
</body>
</html>
